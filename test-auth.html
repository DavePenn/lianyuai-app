<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹è¯­AI - ç™»å½•æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #ff3e79 0%, #9c27b0 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .test-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            max-width: 400px;
            width: 100%;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-header h1 {
            color: #2d3436;
            margin: 0;
            font-size: 24px;
        }
        
        .test-header p {
            color: #636e72;
            margin: 10px 0 0 0;
        }
        
        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
        }
        
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #2d3436;
            font-size: 16px;
        }
        
        .test-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .test-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 12px;
        }
        
        .status-pass {
            background-color: #00cec9;
        }
        
        .status-fail {
            background-color: #e17055;
        }
        
        .status-pending {
            background-color: #fdcb6e;
        }
        
        .google-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            color: #757575;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            margin-top: 15px;
        }
        
        .google-btn:hover {
            background: #f8f9fa;
            border-color: #bbb;
        }
        
        .google-btn:disabled {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }
        
        .error-log {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 12px;
            color: #c53030;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .success-log {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 12px;
            color: #276749;
        }
        
        .nav-link {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff3e79 0%, #9c27b0 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .nav-link:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ” ç™»å½•åŠŸèƒ½æµ‹è¯•</h1>
            <p>æ‹è¯­AIè®¤è¯ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</p>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“¦ ä¾èµ–æ£€æŸ¥</h3>
            <div id="dependencies-check"></div>
        </div>
        
        <div class="test-section">
            <h3>âš™ï¸ é…ç½®éªŒè¯</h3>
            <div id="config-check"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”— Google OAuthæµ‹è¯•</h3>
            <div id="oauth-check"></div>
            <button id="test-google-btn" class="google-btn" disabled>
                <i class="fab fa-google"></i>
                æµ‹è¯•Googleç™»å½•
            </button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ” ä¼ ç»Ÿç™»å½•æµ‹è¯•</h3>
            <div id="traditional-login-check"></div>
        </div>
        
        <div id="test-results"></div>
        
        <a href="index.html" class="nav-link">è¿”å›ä¸»åº”ç”¨</a>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="config/oauth-config.js"></script>
    <script src="api/backend-service.js"></script>
    
    <script>
        class AuthTester {
            constructor() {
                this.testResults = {
                    dependencies: {},
                    config: {},
                    oauth: {},
                    traditional: {}
                };
                this.init();
            }
            
            init() {
                console.log('åˆå§‹åŒ–è®¤è¯æµ‹è¯•å™¨...');
                this.runTests();
            }
            
            async runTests() {
                await this.checkDependencies();
                await this.checkConfig();
                await this.checkOAuth();
                await this.checkTraditionalLogin();
                this.updateUI();
            }
            
            async checkDependencies() {
                const deps = this.testResults.dependencies;
                
                // æ£€æŸ¥Google SDK
                deps.googleSDK = typeof google !== 'undefined' && google.accounts;
                
                // æ£€æŸ¥OAuthé…ç½®
                deps.oauthConfig = typeof window.OAuthConfig !== 'undefined';
                
                // æ£€æŸ¥åç«¯æœåŠ¡
                deps.backendService = typeof window.BackendService !== 'undefined';
                
                // æ£€æŸ¥è®¤è¯æ¨¡å—
                deps.authManager = typeof window.AuthManager !== 'undefined' || 
                                  document.querySelector('script[src*="auth.js"]') !== null;
                
                // æ£€æŸ¥å¢å¼ºè½®æ’­
                deps.enhancedCarousel = typeof window.EnhancedCarousel !== 'undefined' || 
                                       document.querySelector('script[src*="carousel-enhanced.js"]') !== null;
            }
            
            async checkConfig() {
                const config = this.testResults.config;
                
                try {
                    if (window.OAuthConfig) {
                        const oauthConfig = window.OAuthConfig.getCurrentConfig();
                        
                        // æ£€æŸ¥Googleå®¢æˆ·ç«¯ID
                        config.googleClientId = oauthConfig.google.clientId && 
                                              !oauthConfig.google.clientId.includes('æ‚¨çš„Googleå®¢æˆ·ç«¯ID');
                        
                        // æ£€æŸ¥é…ç½®åˆå§‹åŒ–
                        config.oauthInit = window.OAuthConfig.initialize();
                    } else {
                        config.googleClientId = false;
                        config.oauthInit = false;
                    }
                    
                    // æ£€æŸ¥åç«¯é…ç½®
                    if (window.BackendService) {
                        const backendService = new window.BackendService();
                        config.backendUrl = !!backendService.baseURL;
                    } else {
                        config.backendUrl = false;
                    }
                    
                } catch (error) {
                    console.error('é…ç½®æ£€æŸ¥å¤±è´¥:', error);
                    config.error = error.message;
                }
            }
            
            async checkOAuth() {
                const oauth = this.testResults.oauth;
                
                try {
                    // æ£€æŸ¥Google APIsæ˜¯å¦åŠ è½½
                    oauth.googleAPIs = typeof google !== 'undefined' && 
                                      google.accounts && 
                                      google.accounts.id;
                    
                    if (oauth.googleAPIs && this.testResults.config.googleClientId) {
                        // å°è¯•åˆå§‹åŒ–Google OAuth
                        try {
                            const testConfig = {
                                client_id: window.OAuthConfig.getCurrentConfig().google.clientId,
                                callback: () => {},
                                auto_select: false
                            };
                            
                            google.accounts.id.initialize(testConfig);
                            oauth.initialization = true;
                            
                            // å¯ç”¨æµ‹è¯•æŒ‰é’®
                            document.getElementById('test-google-btn').disabled = false;
                            
                        } catch (error) {
                            oauth.initialization = false;
                            oauth.initError = error.message;
                        }
                    } else {
                        oauth.initialization = false;
                        oauth.reason = 'Google APIsæœªåŠ è½½æˆ–å®¢æˆ·ç«¯IDæœªé…ç½®';
                    }
                    
                } catch (error) {
                    console.error('OAuthæ£€æŸ¥å¤±è´¥:', error);
                    oauth.error = error.message;
                }
            }
            
            async checkTraditionalLogin() {
                const traditional = this.testResults.traditional;
                
                try {
                    if (window.BackendService) {
                        const backendService = new window.BackendService();
                        
                        // æ£€æŸ¥åç«¯è¿æ¥
                        try {
                            // å°è¯•è·å–é…ç½®ï¼ˆä¸éœ€è¦è®¤è¯çš„æ¥å£ï¼‰
                            await backendService.getAIConfig();
                            traditional.backendConnection = true;
                        } catch (error) {
                            traditional.backendConnection = false;
                            traditional.connectionError = error.message;
                        }
                        
                        // æ£€æŸ¥ç™»å½•æ¥å£
                        traditional.loginInterface = typeof backendService.login === 'function';
                        traditional.registerInterface = typeof backendService.register === 'function';
                        traditional.googleAuthInterface = typeof backendService.googleAuth === 'function';
                        
                    } else {
                        traditional.backendConnection = false;
                        traditional.reason = 'åç«¯æœåŠ¡æœªåŠ è½½';
                    }
                    
                } catch (error) {
                    console.error('ä¼ ç»Ÿç™»å½•æ£€æŸ¥å¤±è´¥:', error);
                    traditional.error = error.message;
                }
            }
            
            updateUI() {
                this.updateDependenciesUI();
                this.updateConfigUI();
                this.updateOAuthUI();
                this.updateTraditionalLoginUI();
                
                // ç»‘å®šæµ‹è¯•æŒ‰é’®äº‹ä»¶
                document.getElementById('test-google-btn').addEventListener('click', () => {
                    this.testGoogleLogin();
                });
            }
            
            updateDependenciesUI() {
                const container = document.getElementById('dependencies-check');
                const deps = this.testResults.dependencies;
                
                container.innerHTML = `
                    ${this.createTestItem('Google SDK', deps.googleSDK)}
                    ${this.createTestItem('OAuthé…ç½®', deps.oauthConfig)}
                    ${this.createTestItem('åç«¯æœåŠ¡', deps.backendService)}
                    ${this.createTestItem('è®¤è¯æ¨¡å—', deps.authManager)}
                    ${this.createTestItem('å¢å¼ºè½®æ’­', deps.enhancedCarousel)}
                `;
            }
            
            updateConfigUI() {
                const container = document.getElementById('config-check');
                const config = this.testResults.config;
                
                container.innerHTML = `
                    ${this.createTestItem('Googleå®¢æˆ·ç«¯ID', config.googleClientId)}
                    ${this.createTestItem('OAuthåˆå§‹åŒ–', config.oauthInit)}
                    ${this.createTestItem('åç«¯URL', config.backendUrl)}
                    ${config.error ? `<div class="error-log">é…ç½®é”™è¯¯: ${config.error}</div>` : ''}
                `;
            }
            
            updateOAuthUI() {
                const container = document.getElementById('oauth-check');
                const oauth = this.testResults.oauth;
                
                container.innerHTML = `
                    ${this.createTestItem('Google APIs', oauth.googleAPIs)}
                    ${this.createTestItem('OAuthåˆå§‹åŒ–', oauth.initialization)}
                    ${oauth.initError ? `<div class="error-log">åˆå§‹åŒ–é”™è¯¯: ${oauth.initError}</div>` : ''}
                    ${oauth.reason ? `<div class="error-log">åŸå› : ${oauth.reason}</div>` : ''}
                    ${oauth.error ? `<div class="error-log">æ£€æŸ¥é”™è¯¯: ${oauth.error}</div>` : ''}
                `;
            }
            
            updateTraditionalLoginUI() {
                const container = document.getElementById('traditional-login-check');
                const traditional = this.testResults.traditional;
                
                container.innerHTML = `
                    ${this.createTestItem('åç«¯è¿æ¥', traditional.backendConnection)}
                    ${this.createTestItem('ç™»å½•æ¥å£', traditional.loginInterface)}
                    ${this.createTestItem('æ³¨å†Œæ¥å£', traditional.registerInterface)}
                    ${this.createTestItem('Googleè®¤è¯æ¥å£', traditional.googleAuthInterface)}
                    ${traditional.connectionError ? `<div class="error-log">è¿æ¥é”™è¯¯: ${traditional.connectionError}</div>` : ''}
                    ${traditional.reason ? `<div class="error-log">åŸå› : ${traditional.reason}</div>` : ''}
                    ${traditional.error ? `<div class="error-log">æ£€æŸ¥é”™è¯¯: ${traditional.error}</div>` : ''}
                `;
            }
            
            createTestItem(name, status) {
                const statusClass = status === true ? 'status-pass' : 
                                  status === false ? 'status-fail' : 'status-pending';
                const statusText = status === true ? 'âœ“' : 
                                 status === false ? 'âœ—' : '?';
                
                return `
                    <div class="test-item">
                        <div class="test-status ${statusClass}">${statusText}</div>
                        <span>${name}</span>
                    </div>
                `;
            }
            
            testGoogleLogin() {
                const button = document.getElementById('test-google-btn');
                const resultsContainer = document.getElementById('test-results');
                
                button.disabled = true;
                button.textContent = 'æ­£åœ¨æµ‹è¯•...';
                
                try {
                    google.accounts.id.prompt((notification) => {
                        if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                            resultsContainer.innerHTML = `
                                <div class="error-log">
                                    Googleç™»å½•æç¤ºè¢«è·³è¿‡æˆ–æ— æ³•æ˜¾ç¤º<br>
                                    åŸå› : ${notification.getNotDisplayedReason() || notification.getSkippedReason() || 'æœªçŸ¥'}
                                </div>
                            `;
                        } else {
                            resultsContainer.innerHTML = `
                                <div class="success-log">
                                    Googleç™»å½•æç¤ºå·²æ˜¾ç¤ºï¼ŒåŠŸèƒ½æ­£å¸¸
                                </div>
                            `;
                        }
                        
                        button.disabled = false;
                        button.innerHTML = '<i class="fab fa-google"></i> æµ‹è¯•Googleç™»å½•';
                    });
                    
                } catch (error) {
                    resultsContainer.innerHTML = `
                        <div class="error-log">
                            Googleç™»å½•æµ‹è¯•å¤±è´¥: ${error.message}
                        </div>
                    `;
                    
                    button.disabled = false;
                    button.innerHTML = '<i class="fab fa-google"></i> æµ‹è¯•Googleç™»å½•';
                }
            }
        }
        
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => new AuthTester(), 1000);
            });
        } else {
            setTimeout(() => new AuthTester(), 1000);
        }
    </script>
</body>
</html>
