# 标准化配置解决方案

## 问题分析

### 当前问题
1. **端口配置混乱**：前端、后端、API服务端口不统一
2. **配置文件分散**：多个配置文件中的端口设置不一致
3. **环境差异**：开发环境和生产环境配置不同步
4. **手动部署错误**：每次部署都需要手动修改配置

### 根本原因
- 缺乏统一的配置管理策略
- 没有标准化的部署流程
- 配置文件之间存在依赖关系但缺乏同步机制

## 标准化解决方案

### 1. 统一端口配置策略

#### 生产环境端口分配
```
前端静态服务器：80端口
后端API服务器：3000端口
数据库服务：3306端口
```

#### 开发环境端口分配
```
前端开发服务器：8080端口
后端API服务器：3001端口
数据库服务：3306端口
```

### 2. 配置文件标准化

#### 主配置文件：`config/app-config.json`
```json
{
  "development": {
    "frontend": {
      "port": 8080,
      "host": "localhost"
    },
    "backend": {
      "port": 3001,
      "host": "localhost",
      "apiPrefix": "/api"
    },
    "database": {
      "host": "localhost",
      "port": 3306,
      "name": "lianyu_ai",
      "user": "lianyu_user"
    }
  },
  "production": {
    "frontend": {
      "port": 80,
      "host": "152.32.218.174"
    },
    "backend": {
      "port": 3000,
      "host": "152.32.218.174",
      "apiPrefix": "/api"
    },
    "database": {
      "host": "localhost",
      "port": 3306,
      "name": "lianyu_ai",
      "user": "lianyu_user"
    }
  }
}
```

### 3. 自动化配置生成脚本

#### `scripts/generate-config.js`
- 读取主配置文件
- 根据环境自动生成各个配置文件
- 确保所有配置文件同步

### 4. 标准化部署流程

#### 部署前检查清单
1. ✅ 验证配置文件一致性
2. ✅ 检查端口可用性
3. ✅ 验证数据库连接
4. ✅ 测试API接口
5. ✅ 验证前端资源加载

#### 自动化部署脚本：`deploy-standard.sh`
```bash
#!/bin/bash
# 标准化部署脚本

# 1. 生成配置文件
node scripts/generate-config.js production

# 2. 同步代码到服务器
./scripts/sync-code.sh

# 3. 重启服务
./scripts/restart-services.sh

# 4. 验证部署
./scripts/verify-deployment.sh
```

### 5. 配置验证机制

#### 配置验证脚本：`scripts/validate-config.js`
- 检查所有配置文件的端口一致性
- 验证环境变量完整性
- 测试服务连通性

### 6. 错误预防措施

#### 开发阶段
1. **Git钩子**：提交前自动验证配置
2. **本地测试**：启动前检查端口冲突
3. **配置锁定**：防止意外修改关键配置

#### 部署阶段
1. **分阶段部署**：先部署后端，再部署前端
2. **回滚机制**：部署失败自动回滚
3. **健康检查**：部署后自动验证服务状态

### 7. 监控和告警

#### 服务监控
- 端口监听状态监控
- API接口可用性监控
- 数据库连接状态监控

#### 告警机制
- 服务异常自动告警
- 配置不一致告警
- 端口冲突告警

## 实施计划

### 第一阶段：配置标准化
1. 创建主配置文件
2. 重构现有配置文件
3. 实现配置生成脚本

### 第二阶段：自动化部署
1. 创建部署脚本
2. 实现配置验证
3. 建立回滚机制

### 第三阶段：监控告警
1. 实现服务监控
2. 建立告警机制
3. 完善文档

## 预期效果

1. **零配置错误**：自动化配置生成，避免人为错误
2. **快速部署**：一键部署，减少部署时间
3. **问题快速定位**：统一的日志和监控
4. **配置可追溯**：所有配置变更都有记录
5. **环境一致性**：开发和生产环境配置同步

## 维护指南

### 日常维护
1. 定期检查配置文件一致性
2. 监控服务运行状态
3. 及时处理告警信息

### 配置变更流程
1. 修改主配置文件
2. 运行配置生成脚本
3. 测试验证
4. 部署到生产环境

### 故障处理
1. 查看监控告警
2. 检查服务日志
3. 验证配置文件
4. 必要时执行回滚

---

**注意**：此方案需要逐步实施，建议先在开发环境测试，确认无误后再应用到生产环境。